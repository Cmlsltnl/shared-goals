{% extends 'base.html' %}
{% load staticfiles %}
{% load markdown_deux_tags %}
{% load humanize %}
{% block content %}
  <div class="row small-gap-below">
    <div class="text-center">
      <h1>{{ request.goal.title }}</h1>
      <div class="button-grp">
        <button class="btn btn-default" onclick="location.href='{% url 'goal' request.goal.slug %}';">Suggestions</button>
        <button class="btn btn-default">Members</button>
        {% if request.member %}
          <button class="btn btn-default" onclick="location.href='{% url 'profile' request.goal.slug %}';">My Profile</button>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="row small-gap-below">
    <div class="col-md-4"></div>
    <div class="col-md-4">
      <div class="suggestion--photo" style="background-image:url({{ suggestion.image.url }});">
        <div class="suggestion--gradient"></div>
        <span class="suggestion--title">
          <span class="title-caption">{{ suggestion.get_type_display }}</span>
          <h3>{{ revision.title }}</h3>
        </span>
      </div>
    </div>
  </div>
  <div class="row small-gap-below">
    <div class="col-md-2"></div>
    <div class="col-md-8">
      <h5>Published by {{ suggestion.owner.global_user.name }}, {{ suggestion.pub_date|naturaltime }}</h5>{{ revision.description|markdown }}</div>
  </div>
  <div id="reviews"></div><script>
// suggestion/load_reviews.js
sgreviews = function() {
    $('div.rateit, span.rateit').rateit();

    function on_comment_form_submit(event) {
        event.preventDefault();

        // Send the data using post
        var form = $(this);
        var posting = $.post(
            form.data("ajax-url"),
            form.serialize() + "&submit=" + $(document.activeElement)[0].value
        );

        // Put the results in a div
        posting.done(function(data) {
            if (data.success) {
                load_comment_block(0, form.closest(".comment-block"));
            }
        });
    }

    function init_reply_div() {
        // connect post button to do an ajax post
        form = $(this).find("form")[0];
        url_get_reply_form = $(this).data("ajax-url");
        $(form).data("ajax-url", url_get_reply_form);
        $(form).submit(on_comment_form_submit);
    }

    function on_click_reply_link() {
        // respond to clicking on $(this) reply link by showing a reply form
        reply_div = $(this).siblings(".comment-reply-div")[0];
        url_get_reply_form = $(this).data("ajax-url");
        $(reply_div).data("ajax-url", url_get_reply_form);
        $(reply_div).load(url_get_reply_form, init_reply_div);
    }

    function init_comment_block() {
        // connect all reply-links within $(this) comment-block
        $(this).find(".comment-reply-link").each(function(index, reply_link) {
            $(reply_link).click(on_click_reply_link);
        });
    }

    function load_comment_block(dummy_index, comment_block) {
        // load comments into this comment-block
        url_get_comment_block = $(comment_block).data("ajax-url");
        $(comment_block).load(url_get_comment_block, init_comment_block);
    }

    (function($) {
        $.fn.load_comment_block = function() {
            return this.each(load_comment_block);
        };
    }(jQuery));

    $(".comment-block").load_comment_block();
}

$(document).ready(function() {
    $("#reviews").load(
        "{% url 'reviews' request.goal.slug suggestion.slug %}",
        sgreviews
    );
});
</script>{% endblock %}
